<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>搞笑GIF</title>
	<style>
		*{margin: 0;padding: 0;}
		#container{
			width: 90%;
			margin: auto;
		}
		#container h1{
			text-align: center;
			margin: 20px 0;
		}
		#list li{
			width: 20%;
			list-style: none;
			float:left;
			box-sizing:border-box;
			padding:5px;
		}
		#list li div + div {
			margin-top: 20px;
		}
		#list li div img{
			width: 100%;
		}
	</style>
</head>
<body>
	<div id="container">
		<h1>搞笑GIF</h1>
		<ul id="list">
			<li></li>
			<li></li>
			<li></li>
			<li></li>
			<li></li>
		</ul>
	</div>
	<script src="AJAX.js"></script>
	<script>
		var aLis = document.getElementsByTagName("li");
		var cPage = 1;
		var onOff = true;
		getData(cPage);
		function getData(cPage){
			var url = "https://route.showapi.com/341-3?maxResult=20&page="+cPage+"&showapi_appid=41249&showapi_sign=b3df448fb71d46f4a99a751d85b91996";
			ajax("get",url,"",function(data){
				data = JSON.parse(data).showapi_res_body;
				var contentlist = data.contentlist;
				
				(function loadImg(i){
					if(i > 19){
						onOff = true;
						console.log(onOff)
						return;
					}
					onOff = false;
					var item = contentlist[i];
					var oDiv = document.createElement("div"),
					    oP = document.createElement("p"),
						oImg = document.createElement("img");
					// console.log(_index)
					oImg.src = item.img;
					oP.innerHTML = item.title;
					oImg.onload = function(){
						var _index = getShort();
						oDiv.appendChild(oImg);
						oDiv.appendChild(oP);
						aLis[_index].appendChild(oDiv);
						i++;
						loadImg(i);
					}
				})(0)
			})
		}
		window.onscroll = function(){
			var _index = getShort();
			var oLi = aLis[_index];
			var aliH = oLi.offsetHeight;
			var aliT = getTop(oLi);
			var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
			var wH = document.documentElement.clientHeight;
			if(aliH + aliT < scrollTop + wH){
				if(onOff){
					cPage++;
					getData(cPage);
				}
			}
		}
		function getTop(obj){
			var iTop = 0;
			while(obj){
				iTop += obj.offsetTop;
				obj = obj.offsetParent;
			}
			return iTop;
		}
		function getShort(){
			var index = 0;
			var ih = aLis[index].offsetHeight;
			for(var i=0;i<aLis.length;i++){
				if(aLis[i].offsetHeight < ih){
					index = i;
					ih = aLis[i].offsetHeight;
				}
			}
			return index;
		}
	</script>
</body>
</html>